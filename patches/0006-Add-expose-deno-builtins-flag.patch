From 84cb53578c30ba8491d026551f9fb755d01b90b4 Mon Sep 17 00:00:00 2001
From: Divy Srivastava <dj.srivastava23@gmail.com>
Date: Fri, 6 Oct 2023 17:15:26 +0530
Subject: [PATCH] Add `--expose-deno-builtins` flag

---
 src/flags/flag-definitions.h |  3 +++
 src/init/bootstrapper.cc     | 17 +++++++++--------
 2 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/src/flags/flag-definitions.h b/src/flags/flag-definitions.h
index 1bd295bf9f5..483fe23ee4a 100644
--- a/src/flags/flag-definitions.h
+++ b/src/flags/flag-definitions.h
@@ -1948,6 +1948,9 @@ DEFINE_BOOL(disallow_code_generation_from_strings, false,
 DEFINE_BOOL(expose_async_hooks, false, "expose async_hooks object")
 DEFINE_STRING(expose_cputracemark_as, nullptr,
               "expose cputracemark extension under the specified name")
+DEFINE_BOOL(expose_deno_builtins, false,
+              "expose builtins used by Deno's internal code")
+
 #ifdef ENABLE_VTUNE_TRACEMARK
 DEFINE_BOOL(enable_vtune_domain_support, true, "enable vtune domain support")
 #endif  // ENABLE_VTUNE_TRACEMARK
diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc
index 69633a99668..aec9a0bac59 100644
--- a/src/init/bootstrapper.cc
+++ b/src/init/bootstrapper.cc
@@ -3443,19 +3443,20 @@ void Genesis::InitializeGlobal(Handle<JSGlobalObject> global_object,
     JSObject::AddProperty(isolate_, prototype, factory->iterator_symbol(),
                           values, DONT_ENUM);
 
-    SimpleInstallFunction(isolate_, global, "isOneByte",
-                          Builtin::kStringIsOneByte, 1, false);
+    if (v8_flags.expose_deno_builtins) {
+      // Deno-specific methods. See deno_core/01_core.js
+      SimpleInstallFunction(isolate_, global, "fromUtf8",
+                            Builtin::kTypedArrayUtf8String, 1, false);
+      SimpleInstallFunction(isolate_, global, "toUtf8",
+                            Builtin::kStringToUtf8, 1, false);
+      SimpleInstallFunction(isolate_, global, "isOneByte",
+                            Builtin::kStringIsOneByte, 1, false);
+    }
 
     // TODO(caitp): alphasort accessors/methods
     SimpleInstallFunction(isolate_, prototype, "at",
                           Builtin::kTypedArrayPrototypeAt, 1, true);
 
-    // Deno-specific methods. See deno_core/01_core.js
-    SimpleInstallFunction(isolate_, global, "fromUtf8",
-                          Builtin::kTypedArrayUtf8String, 1, false);
-    SimpleInstallFunction(isolate_, global, "toUtf8",
-                          Builtin::kStringToUtf8, 1, false);
-
     SimpleInstallFunction(isolate_, prototype, "copyWithin",
                           Builtin::kTypedArrayPrototypeCopyWithin, 2, false);
     SimpleInstallFunction(isolate_, prototype, "every",
-- 
2.37.1 (Apple Git-137.1)

